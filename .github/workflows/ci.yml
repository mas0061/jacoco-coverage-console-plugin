name: CI

on:
  pull_request:
    paths-ignore:
      - '**/*.md'
      - 'LICENSE'
      - '.gitignore'

permissions:
  contents: read
  actions: read
  checks: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        java: [8, 11, 17, 21]

    name: Test with Java ${{ matrix.java }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
      with:
        # Fetch full history for better analysis
        fetch-depth: 0
    
    - name: Set up JDK ${{ matrix.java }}
      uses: actions/setup-java@dded0888837ed1f317902acf8a20df0ad188d165 # v5.0.0
      with:
        java-version: ${{ matrix.java }}
        distribution: 'corretto'
    
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@4d9f0ba0025fe599b4ebab900eb7f3a1d93ef4c2 # v5.0.0
      with:
        cache-read-only: ${{ github.ref != 'refs/heads/main' }}
    
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
    
    - name: Run quality checks and tests
      run: ./gradlew qualityCheck test jacocoTestReport --continue
    
    - name: Upload test reports
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      if: always()
      with:
        name: test-reports-java${{ matrix.java }}
        path: |
          build/reports/ktlint/
          build/reports/detekt/
          build/reports/jacoco/
          build/reports/tests/test/
        retention-days: ${{ matrix.java == 17 && 30 || 7 }}
        
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@34d7c956a59aed1bfebf31df77b8de55db9bbaaf # v2.21.0
      if: always()
      with:
        files: build/test-results/test/*.xml
        check_name: "Test Results (Java ${{ matrix.java }})"

    - name: Generate coverage summary
      if: always() && matrix.java == 17
      run: |
        if [ -f "build/reports/jacoco/test/jacocoTestReport.xml" ]; then
          echo "COVERAGE_REPORT_EXISTS=true" >> $GITHUB_ENV
          # Extract coverage percentage from JaCoCo XML report
          COVERAGE=$(grep -o 'missed="[0-9]*".*covered="[0-9]*"' build/reports/jacoco/test/jacocoTestReport.xml | head -1 | sed 's/missed="\([0-9]*\)".*covered="\([0-9]*\)"/\1 \2/' | awk '{total=$1+$2; if(total>0) print ($2*100/total); else print 0}')
          echo "COVERAGE_PERCENTAGE=${COVERAGE}" >> $GITHUB_ENV
        else
          echo "COVERAGE_REPORT_EXISTS=false" >> $GITHUB_ENV
        fi

    - name: Check detekt results
      id: detekt_check
      if: always() && matrix.java == 17
      run: |
        if [ -f "build/reports/detekt/detekt.txt" ]; then
          if grep -q "Issues found:" build/reports/detekt/detekt.txt; then
            echo "status=âŒ **detekt:** Issues found" >> $GITHUB_OUTPUT
          else
            echo "status=âœ… **detekt:** No issues found" >> $GITHUB_OUTPUT
          fi
        else
          echo "status=âš ï¸ **detekt:** Report not found" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment PR with quality results
      if: github.event_name == 'pull_request' && always() && matrix.java == 17
      uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
      with:
        header: quality-report
        message: |
          ## ğŸ” Code Quality Report

          ${{ steps.detekt_check.outputs.status }}
          âœ… **ktlint:** Code style check completed
          ${{ env.COVERAGE_REPORT_EXISTS == 'true' && format('ğŸ“Š **Test Coverage:** {0}%', env.COVERAGE_PERCENTAGE) || '' }}

          ğŸ“ **Artifacts uploaded:**
          - Quality reports (ktlint, detekt)
          ${{ env.COVERAGE_REPORT_EXISTS == 'true' && '- Test coverage reports' || '' }}
          - Test results
